"use strict";exports.__esModule=!0,exports.onlyAdmin=exports.onlyShopper=exports.isAdmin=exports.validatePassword=exports.encryptPassword=exports.doesUserExist=exports.isLoggedInAndAuthenticated=void 0;var secret=require("../../secret/dist/secret").secret,_a=require("../../models/dist/usersModel"),User=_a.User,Users=_a.Users,jwt=require("jsonwebtoken"),bcrypt=require("bcrypt");function isLoggedInAndAuthenticated(r,t,o){try{var e=r.cookies.currentUser;e?jwt.verify(e,secret,function(e,s){e?t.status(401).send({message:"You are not authorized to see this page, mister hacker..."}):(r.currentUser=s,o())}):t.status(401).send({message:"The session has expired. Please log in again."})}catch(e){console.error(e.message),t.status(500).send(e.message)}}function doesUserExist(e,s,r){try{var t=new Users;if(e.currentUser){var o=e.currentUser.userUuid;void 0!==(u=t.findUserIndex(o,null))?(e.userUuid=o,e.userIndex=u,r()):s.status(404).send({message:"User wasn't found, mister hacker..."})}else{var n=e.body,a=n.email,d=n.adminRegisterForm,i=n.adminLoginForm,u=t.findUserIndex(null,a);if(d)return-1!==u?(e.encryptedPassword=t.users[u].password,e.userIndex=u):(e.shopperToAdmin=!1,e.userIndex=u,e.role="admin"),void r();if(void 0!==i)return void(-1===u?s.status(404).send({message:"User doesn't exist. Please register to the system."}):(e.userIndex=u,r()));if(-1===u)return e.shopperToAdmin=!1,e.userIndex=u,e.role="shopper",void r();s.status(409).send({message:"Email already registered. Please use a different one."})}}catch(e){console.error(e.message),s.status(500).send(e.message)}}function encryptPassword(r,t,o){try{var e=r.body.password;bcrypt.hash(e,10,function(e,s){try{if(e)throw new Error("Issues in the password encryption process!");r.body.password=s,o()}catch(e){console.error(e.message),t.status(500).send(e.message)}})}catch(e){console.error(e.message),t.status(500).send(e.message)}}function validatePassword(o,n,a){try{if(o.role)return void a();var e=o.body.password,d=new Users,i=o.userIndex,s=void 0,s=o.encryptedPassword?o.encryptedPassword:d.users[i].password;bcrypt.compare(e,s,function(e,s){try{if(e)throw n.status(409).send({message:"The password you entered is incorrect."});if(s){if(o.encryptedPassword){var r=o.body.username,t=0===d.users[i].stores?"\n\nShopper trying to become an admin? Please verify you credentials.":"";return 0===d.users[i].stores.length&&d.users[i].username===r?(o.shopperToAdmin=!0,o.role="admin",void a()):void n.status(409).send({message:"Email already registered."+t})}o.shopperToAdmin=!1,o.role=0===d.users[i].stores.length?"shopper":"admin",a()}else n.status(409).send({message:"The password you entered is incorrect."})}catch(e){console.error(e.message),n.status(500).send(e.message)}})}catch(e){console.error(e.message),n.status(500).send(e.message)}}function isAdmin(e,s,r){try{var t=new Users,o=e.userIndex;e.isAdmin=0<t.users[o].stores.length,r()}catch(e){console.error(e.message),s.status(500).send(e.message)}}function onlyShopper(e,s,r){try{e.isAdmin?s.status(403).send({message:"This functionality is for shoppers only."}):r()}catch(e){console.error(e.message),s.status(500).send(e.message)}}function onlyAdmin(e,s,r){try{e.isAdmin?r():s.status(403).send({message:"This functionality is for admins only."})}catch(e){console.error(e.message),s.status(500).send(e.message)}}exports.isLoggedInAndAuthenticated=isLoggedInAndAuthenticated,exports.doesUserExist=doesUserExist,exports.encryptPassword=encryptPassword,exports.validatePassword=validatePassword,exports.isAdmin=isAdmin,exports.onlyShopper=onlyShopper,exports.onlyAdmin=onlyAdmin;