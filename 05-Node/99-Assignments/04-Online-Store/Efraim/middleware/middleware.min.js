var Ajv=require("ajv"),ajv=new Ajv,addFormats=require("ajv-formats");addFormats(ajv);var bcrypt=require("bcrypt"),jwt=require("jsonwebtoken"),dotenv=require("dotenv").config(),users=require("../models/classes").users;exports.validateBody=function(o){return function(e,r,s){ajv.validate(o,e.body)?s():r.status(400).send(ajv.errors[0].message)}},exports.checkAdminAccountCreated=function(e,r,s){try{var o=e.body.admincode;if(o&&o===process.env.ADMIN_CODE&&(e.body.role=process.env.ADMIN_ROLE,s()),o&&o!=process.env.ADMIN_CODE)return void r.status(400).send("admin code not correct");s()}catch(e){console.error(e)}},exports.encryptPwd=function(s,o,t){var e=s.body.password;bcrypt.hash(e,10,function(e,r){e?o.status(500).send("Error Encrypting"):(s.body.password=r,t())})},exports.decryptPwd=function(e,r,s){try{var o=e.body,t=o.email,n=o.password,a=users.users.find(function(e){return e.email===t});bcrypt.compare(n,a.password,function(e,r){if(e)throw new Error("Incorrect password");r&&s()})}catch(e){r.status(400).send(e)}},exports.authorization=function(s,o,t){var e,r=s.headers.authorization;r?(e=r.replace("Bearer ",""),jwt.verify(e,process.env.SECRET_KEY,function(e,r){e?o.status(401).send("Invalid Token"):(s.decoded=r,t())})):o.status(401).send("Must provide a token")},exports.createTokenAndRoleCheck=function(r,e,s){try{var o=users.users.find(function(e){return r.body.email===e.email}),t=jwt.sign({userID:o.userID},process.env.SECRET_KEY,{expiresIn:"1h"});r.token=t,o.role===process.env.ADMIN_ROLE?e.send({URL:"/adminpage.html",token:t}):s()}catch(e){console.error(e)}},exports.checkPassword=function(e,r,s){try{var o=e.body;o.password===o.repassword?s():r.status(400).send("passwords don't match!")}catch(e){console.error(e)}},exports.checkAdminForAllReq=function(e,r,s){try{var o=e.decoded.userID;users.findUser(o).role===process.env.ADMIN_ROLE?s():r.status(400).send("you are not authorised to do that!!")}catch(e){console.error(e)}},exports.checkEmailValid=function(e,r,s){try{var o=e.body.email;users.users.find(function(e){return e.email===o})?r.status(400).send("email already taken"):s()}catch(e){console.error(e)}};