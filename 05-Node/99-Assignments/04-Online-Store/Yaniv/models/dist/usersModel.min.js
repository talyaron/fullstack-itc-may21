"use strict";exports.__esModule=!0,exports.Users=exports.User=exports.CartProduct=void 0;var uuidv4=require("uuid").v4,fs=require("fs"),path=require("path"),usersJsonPath=path.resolve(__dirname,"../users.json"),storeJsonPath=path.resolve(__dirname,"../store.json"),_a=require("./storeModel"),readStoreJson=_a.readStoreJson,Product=_a.Product,Store=_a.Store,readUsersJson=function(){try{var r=fs.readFileSync(usersJsonPath);return JSON.parse(r)}catch(r){console.error(r.message)}},CartProduct=function(r){this.productUuid=r,this.totalPrice=0,this.quantity=0};exports.CartProduct=CartProduct;var User=function(r,t,s){this.userUuid=uuidv4(),this.email=r,this.username=t,this.password=s,this.stores=[],this.cart=[],this.purchased=[]};exports.User=User;var Users=function(){function r(){this.users=readUsersJson()}return r.prototype.updateUsersJson=function(){try{fs.writeFileSync(usersJsonPath,JSON.stringify(this.users))}catch(r){console.error(r.message)}},r.prototype.findUserIndex=function(t,s){try{var r=t?this.users.findIndex(function(r){return r.userUuid===t}):this.users.findIndex(function(r){return r.email===s});if(-1===r&&t)throw new Error("no user with uuid "+t);return r}catch(r){console.error(r.message)}},r.prototype.storeUuid=function(){try{var r,t=this.users.findIndex(function(r){return 0<r.stores.length}),s=void 0;return-1===t?(s=uuidv4(),(r=readStoreJson()).storeUuid=s,fs.writeFileSync(storeJsonPath,JSON.stringify(r))):s=this.users[t].stores[0],s}catch(r){console.error(r.message)}},r.prototype.addUser=function(r,t,s,e,o,u){try{var i=new User(r,t,s),n="admin"===u?this.storeUuid():void 0,a=e?this.users[o].userUuid:i.userUuid;return"admin"===u?e?this.users[o].stores.push(n):(i.stores.push(n),this.users.push(i)):this.users.push(i),this.updateUsersJson(),{userUuid:a,storeUuid:n}}catch(r){console.error(r.message)}},r.prototype.completeCartProductDetails=function(r,t){try{var s=readStoreJson().products.find(function(r){return r.productUuid===t}),e=s.productPrice,o=new CartProduct(t);return o.productName=s.productName,o.quantity=r,o.totalPrice=e*r,o}catch(r){console.error(r.message)}},r.prototype.addCartProduct=function(r,t){try{var s=this.findUserIndex(r,null),e=this.completeCartProductDetails(0,t);this.users[s].cart.push(e);var o=this.users[s].cart.length-1;return this.updateUsersJson(),o}catch(r){console.error(r.message)}},r.prototype.findCartProduct=function(r,t,s){try{var e=this.users[r].cart.findIndex(function(r){return r.productUuid===t});return-1===e&&"+"===s&&(e=this.addCartProduct(this.users[r].userUuid,t)),e}catch(r){console.error(r.message)}},r.prototype.deleteCartProduct=function(r,t){try{var s=this.findUserIndex(r,null);this.users[s].cart=this.users[s].cart.filter(function(r){return r.productUuid!==t}),this.updateUsersJson()}catch(r){console.error(r.message)}},r.prototype.updateCartProductQuantity=function(r,t,s){try{var e=this.findUserIndex(r,null),o=this.findCartProduct(e,t,s);"+"===s?this.users[e].cart[o].quantity++:this.users[e].cart[o].quantity--;var u=this.users[e].cart[o].quantity,i=void 0;return 0===u?this.deleteCartProduct(r,t):(i=this.completeCartProductDetails(u,t),this.users[e].cart[o]=i),this.updateUsersJson(),i}catch(r){console.error(r.message)}},r.prototype.updatePurcased=function(s){var e=this;try{this.users[s].cart.forEach(function(t){var r=e.users[s].purchased.findIndex(function(r){return r.productUuid==t.productUuid});-1===r?e.users[s].purchased.push(t):(e.users[s].purchased[r].quantity+=t.quantity,e.users[s].purchased[r].totalPrice+=t.totalPrice)});var o=readStoreJson();this.users[s].cart.forEach(function(t){var r=o.products.findIndex(function(r){return r.productUuid===t.productUuid});o.products[r].inStock-=t.quantity}),fs.writeFileSync(storeJsonPath,JSON.stringify(o))}catch(r){console.error(r.message)}},r.prototype.emptyCart=function(r){try{var t=this.findUserIndex(r,null);this.updatePurcased(t),this.users[t].cart=[],this.updateUsersJson()}catch(r){console.error(r.message)}},r}();exports.Users=Users;