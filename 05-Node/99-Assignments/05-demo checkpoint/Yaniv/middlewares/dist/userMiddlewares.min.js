"use strict";exports.__esModule=!0,exports.validatePassword=exports.encryptPassword=exports.doesUserExist=exports.validateBody=exports.isLoggedInAndAuthenticated=void 0;var Ajv=require("ajv"),ajv=new Ajv,addFormats=require("ajv-formats");addFormats(ajv);var secret=require("../../secret/dist/secret").secret,_a=require("../../models/dist/usersModel"),User=_a.User,Users=_a.Users,jwt=require("jsonwebtoken"),bcrypt=require("bcrypt");function isLoggedInAndAuthenticated(r,t,a){try{var e=r.cookies.currentUser;e?jwt.verify(e,secret,function(e,s){e?t.status(401).send({message:"You are not authorized to see this page, mister hacker..."}):(r.currentUser=s,a())}):t.status(401).send({message:"The session has expired. Please log in again."})}catch(e){console.error(e.message),t.status(500).send(e.message)}}function validateBody(t){try{return function(e,s,r){try{if(!ajv.validate(t,e.body))return void s.status(400).send(ajv.errors[0].message);r()}catch(e){console.error(e.message),s.status(500).send(e.message)}}}catch(e){console.error(e.message)}}function doesUserExist(e,s,r){try{var t=new Users;if(!e.currentUser){var a=e.body,o=a.email,n=a.registerOrLogin,d=t.findUserIndex(null,o);return void("login"===n?-1===d?s.status(404).send({message:"User doesn't exist. Please register to the system."}):(e.userIndex=d,r()):-1!==d?s.status(409).send({message:"Email already registered. Please use a different one."}):r())}var d,i=e.currentUser.userUuid;void 0!==(d=t.findUserIndex(i,null))?(e.userUuid=i,e.userIndex=d,r()):s.status(404).send({message:"User wasn't found, mister hacker..."})}catch(e){console.error(e.message),s.status(500).send(e.message)}}function encryptPassword(r,t,a){try{var e=r.body.password;bcrypt.hash(e,10,function(e,s){try{if(e)throw new Error("Issues in the password encryption process!");r.body.password=s,a()}catch(e){console.error(e.message),t.status(500).send(e.message)}})}catch(e){console.error(e.message),t.status(500).send(e.message)}}function validatePassword(e,r,t){try{var s=e.body.password,a=new Users,o=e.userIndex,n=a.users[o].password;bcrypt.compare(s,n,function(e,s){try{if(e)throw r.status(409).send({message:"The password you entered is incorrect."});s?t():r.status(409).send({message:"The password you entered is incorrect."})}catch(e){console.error(e.message),r.status(500).send(e.message)}})}catch(e){console.error(e.message),r.status(500).send(e.message)}}exports.isLoggedInAndAuthenticated=isLoggedInAndAuthenticated,exports.validateBody=validateBody,exports.doesUserExist=doesUserExist,exports.encryptPassword=encryptPassword,exports.validatePassword=validatePassword;